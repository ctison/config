#!/bin/sh

set -e

NAMESPACE="${1:-default}"
NAME=$(echo "${PWD##*/}" | tr '. ' '-')

FILE=$(cat <<EOF
kind: Pod
apiVersion: v1
metadata:
  name: "$NAME"
spec:
  hostname: "$NAME"
  restartPolicy: Never
  volumes:
    - name: hostvolume
      hostPath:
        path: "${PWD}"
        type: Directory
    - name: docker
      hostPath:
        path: /var/run/docker.sock
        type: Socket
  containers:
    - image: ctison/kali
      imagePullPolicy: Never
      name: kali
      stdin: true
      tty: true
      volumeMounts:
        - name: hostvolume
          mountPath: "/$NAME"
        - name: docker
          mountPath: /var/run/docker.sock
      workingDir: "/$NAME"
EOF
)

echo "$FILE" | kubectl -n "$NAMESPACE" apply -f-
kubectl -n "$NAMESPACE" wait --for=condition=Ready -- "pod/$NAME"
kubectl -n "$NAMESPACE" attach -it -- "pod/$NAME"
kubectl -n "$NAMESPACE" delete -- "pod/$NAME"