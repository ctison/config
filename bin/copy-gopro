#!/bin/sh

umask 0077

if [[ $# < 2 || $# > 3 ]]; then
	echo "Usage: $0 GO_PRO_SD_FOLDER DEST_FOLDER [DATE]"
	exit 1
fi

function displayNotification () {
	osascript -e "display notification \"$1\" with title \"ðŸŽ¥ Copy GoPro\""
	echo "$1"
}

MOVIES="`find $1 -type f -iname '*.MP4' -not -name '.*'`"
for M in $MOVIES ; do
	DATE=`date -r $M '+%Y-%m-%d %H-%M-%S'`
	if [[ "$DATE" > "$3" ]]; then
		if [ "`df -g / | tail -n1 | awk -F' ' '{print $4}'`" -lt 10 ]; then
			displayNotification 'ERROR: not enough memory available  ðŸ’¾'
			exit 1
		fi
		NAME="$2/$DATE.MP4"
		printf '%s -> %s ' "$M" "$NAME"
		cp -n -- "$M" "$NAME"
		if [ $? -ne 0 ]; then
			echo KO
		else
			echo OK
		fi
		chmod 0400 "$NAME"
	fi
done

displayNotification 'Finished successfuly ðŸš€'