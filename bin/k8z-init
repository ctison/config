#!/bin/bash
umask 0077
shopt -s nullglob
set -euo pipefail

NAME=${NAME:-${PWD##*/}}

mkdir -p {base,dev,staging,production}/{resources,configs}/
mkdir -p {dev,staging,production}/patches/

cat <<EOF | tee {base,dev,staging,production}/kustomization.yaml >/dev/null
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: $NAME

commonLabels:
  app.kubernetes.io/name: $NAME

EOF

if test $(uname -s) = 'Darwin'; then
  sed -Ei '' 's/^(namespace: .+)$/\1-staging/' staging/kustomization.yaml
else
  sed -Ei 's/^(namespace: .+)$/\1-staging/' staging/kustomization.yaml
fi

cat <<EOF | tee -a {dev,production}/kustomization.yaml >/dev/null
bases:
  - ../base/
EOF

cat >> staging/kustomization.yaml <<EOF
bases:
  - ../production/

patchesJson6902:
  - target:
      version: v1
      kind: Namespace
      name: $NAME
    path: patches/namespace.yaml
EOF

cat <<EOF | tee -a {dev,production}/kustomization.yaml >/dev/null

patchesStrategicMerge:
  - patches/deployment.yaml
EOF

cat > base/configuration.yaml <<EOF
varReference:
  - apiVersion: getambassador.io/v2
    kind: Mapping
    path: spec/service
EOF

cat >> base/kustomization.yaml <<EOF
configurations:
- configuration.yaml

vars:
- name: ${NAME}_SVC_NAME
  objref:
    apiVersion: v1
    kind: Service
    name: $NAME
- name: ${NAME}_SVC_NAMESPACE
  objref:
    apiVersion: v1
    kind: Service
    name: $NAME
  fieldref:
    fieldpath: metadata.namespace

resources:
  - resources/namespace.yaml
  - resources/serviceaccount.yaml
  - resources/clusterrole.yaml
  - resources/clusterrolebinding.yaml
  - resources/deployment.yaml
  - resources/service.yaml
EOF

cat > base/resources/namespace.yaml <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: $NAME
  annotations:
    linkerd.io/inject: enabled
EOF

cat > staging/patches/namespace.yaml <<EOF
- op: replace
  path: /metadata/name
  value: $NAME-staging
EOF

cat > base/resources/serviceaccount.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: $NAME
EOF

cat > base/resources/clusterrole.yaml <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: $NAME
rules: []
EOF

cat > base/resources/clusterrolebinding.yaml <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: $NAME
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: $NAME
subjects:
  - kind: ServiceAccount
    name: $NAME
EOF

cat > base/resources/deployment.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $NAME
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        # seccomp.security.alpha.kubernetes.io/defaultProfileName: runtime/default
    spec:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: $NAME
      containers:
        - name: $NAME
          image: $NAME
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [all]
            privileged: false
            readOnlyRootFilesystem: true
          ports: []
          env: []
          startupProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 3
            periodSeconds: 3
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health/alive
              port: http
            initialDelaySeconds: 3
            periodSeconds: 3
            failureThreshold: 3
          volumeMounts: []
      volumes: []
EOF

cat > dev/patches/deployment.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $NAME
spec:
  template:
    spec:
      containers:
        - name: $NAME
          imagePullPolicy: Never
EOF

cat > production/patches/deployment.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $NAME
spec:
  replicas: 1
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/$NAME: runtime/default
EOF

cat > base/resources/service.yaml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: $NAME
spec:
  ports: []
EOF
