#!/bin/bash
umask 0077
set -euo pipefail
shopt -s nullglob

CONTAINERS=$(docker ps -qf status=created -f status=paused -f status=exited -f status=dead)
# shellcheck disable=SC2086
if [ "$CONTAINERS" ]; then
	docker rm -- $CONTAINERS
fi

IMAGES=$(docker images -f dangling=false --format '{{.Repository}}:{{.Tag}}' | fzf --cycle -m --preview 'docker inspect {} | jq -C' | cut -d' ' -f1)
# shellcheck disable=SC2086
if [ "$IMAGES" ]; then
    docker rmi  -- $IMAGES
fi

IMAGES=$(docker images -qf dangling=true)
# shellcheck disable=SC2086
if [ "$IMAGES" ]; then
    docker rmi  -- $IMAGES
fi

exec docker volume prune -f